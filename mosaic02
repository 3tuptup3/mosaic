from PIL import Image
import numpy as np
import cv2
import csv
import random

# モザイクの粗さ設定
mosaic = 5
# グレーの境界値設定
black_border = 0
white_border = 255
# 入出力設定
input_file = './mosaic_test/test01.jpg'
output_file = './mosaic_test/test01_mosaic.jpg'

# 画像データの読み込み
img = Image.open(input_file)

# グレースケール化
img_gray = img.convert("L")
# 画像を保存する
print(img_gray.getpixel((99, 99)))

# 画像のサイズ(幅[px] x 高さ[px])を取得し、それぞれを変数に代入
width, height = img.size
print(width, height)

quotient_h = height // mosaic
quotient_w = width // mosaic

image_array = np.empty((height, width), dtype = int)

for h in range(height):
    for w in range(width):
        image_array[h][w] = img_gray.getpixel((w, h))

print(image_array)

def make_mosaic(h, w):
    gray_lebel = 0
    for m1 in range(mosaic):
        for m2 in range(mosaic):
            gray_lebel += image_array[h * mosaic + m1][w * mosaic + m2]

    if gray_lebel / (mosaic * mosaic) <= black_border:
        return 0
    elif gray_lebel / (mosaic * mosaic) >= white_border:
        return 255
    else:
        rnd = random.randint(1, 255)
        if rnd <= gray_lebel / (mosaic * mosaic):
            return 255
        else:
            return 0

mosaic_array = np.empty((quotient_h, quotient_w), dtype = int)
for h in range(quotient_h):
    for w in range(quotient_w):
        mosaic_array[h][w] = make_mosaic(h, w)

print(mosaic_array)

Image.fromarray(np.uint8(mosaic_array)).save(output_file)


with open('./mosaic_test/mosaic_picture.csv', 'wt') as f:
    writer = csv.writer(f)
    writer.writerows(mosaic_array)
    